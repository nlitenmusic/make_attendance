<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Attendance - {{ day }} — {{ clinic }}</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding:20px; background:#fafafa; color:#222; }
  .top { display:flex; gap:1rem; align-items:center; margin-bottom:1rem; }
  .btn { padding:.5rem .75rem; border-radius:6px; border:none; cursor:pointer; }
  .back { background:#ddd; }
  .save { background:#007bff; color:white; }
  .add { background:#2ecc71; color:white; }
  .del { background:#ff4b4b; color:white; }
  table { width:100%; border-collapse:collapse; background:white; }
  th, td { border:1px solid #ddd; padding:.5rem; text-align:left; }
  th { background:#f5f5f5; }
  input[type="text"] { width:100%; border:none; padding:.25rem; box-sizing:border-box; }
  form.inline { display:inline-block; margin:0; }
  .row-actions { display:flex; gap:.5rem; }
</style>
</head>
<body>
  <div class="top">
    <a href="{{ url_for('index') }}"><button class="btn back">⬅ Back</button></a>
    <h1 style="margin:0;">Attendance — {{ day }} — {{ clinic }}</h1>
  </div>

  <form method="post" action="{{ url_for('save_attendance') }}">
    <input type="hidden" name="day" value="{{ day }}">
    <input type="hidden" name="clinic" value="{{ clinic }}">

    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Age</th>
          <th>Member Name</th>
          <th>Comments</th>
          <th>Fee</th>
          <th style="width:140px">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for row in data %}
          <tr>
            <td><input type="text" name="player_name" value="{{ row.get('Name','') }}"></td>
            <td><input type="text" name="age" value="{{ row.get('Age','') }}"></td>
            <td><input type="text" name="parent" value="{{ row.get('MemberName','') }}"></td>
            <td><input type="text" name="comments" value="{{ row.get('Comments','') }}"></td>
            <td><input type="text" name="fee" value="{{ row.get('Fee','') }}"></td>

            <td class="row-actions">
              <input type="hidden" name="row_id" value="{{ row.get('row_id','') }}">
              <input type="hidden" name="delete_flag" value="0">
              <!-- Delete button uses JS to avoid nested forms -->
              <button type="button" class="btn del" data-row-id="{{ row.get('row_id','') }}" onclick="deleteRow(this.dataset.rowId)">Delete</button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <div style="margin-top:1rem;">
      <button type="submit" class="btn save">Save Attendance</button>
    </div>
  </form>

  <!-- Add-row form must be OUTSIDE the save_attendance form (no nested forms) -->
  <div style="margin-top:1rem; display:flex; gap:.5rem; align-items:center;">
    <form method="post" action="{{ url_for('add_row') }}">
      <input type="hidden" name="day" value="{{ day }}">
      <input type="hidden" name="clinic" value="{{ clinic }}">
      <button class="btn add" type="submit">+ Add Row</button>
    </form>

    <form method="post" action="{{ url_for('add_date_column') }}" style="display:inline;">
      <input type="hidden" name="day" value="{{ day }}">
      <input type="hidden" name="clinic" value="{{ clinic }}">
      <input type="text" name="new_date" placeholder="New date header (e.g. 1/10)" required>
      <button class="btn" type="submit">+ Add Date Column</button>
    </form>
  </div>

  <!-- in-page confirm modal (hidden by default) -->
  <div id="confirm-modal" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; background:rgba(0,0,0,0.35); z-index:9999;">
    <div style="background:white; padding:1rem 1.25rem; border-radius:8px; width:360px; box-shadow:0 6px 30px rgba(0,0,0,0.2);">
      <h3 style="margin:0 0 .5rem 0;">Confirm delete</h3>
      <p id="confirm-msg" style="margin:0 0 .75rem 0;">Delete this row?</p>
      <label style="display:flex; align-items:center; gap:.5rem; margin-bottom:.75rem;">
        <input id="confirm-dont-ask" type="checkbox"> Don't ask again
      </label>
      <div style="display:flex; gap:.5rem; justify-content:flex-end;">
        <button id="confirm-cancel" class="btn back" type="button">Cancel</button>
        <button id="confirm-ok" class="btn del" type="button">Delete</button>
      </div>
    </div>
  </div>

  <!-- small control to reset stored confirmation preference -->
  <div style="margin-top:.5rem;">
    <button id="reset-delete-confirm" class="btn" type="button" style="background:#eee; color:#111; padding:.25rem .5rem;">Reset delete confirmation</button>
  </div>

  <script>
    // show modal-based confirmation; remembers "don't ask again" in localStorage
    (function () {
      const modal = document.getElementById('confirm-modal');
      const okBtn = document.getElementById('confirm-ok');
      const cancelBtn = document.getElementById('confirm-cancel');
      const dontAskCb = document.getElementById('confirm-dont-ask');
      let pendingRowId = null;

      function openModalFor(rowId) {
        pendingRowId = rowId;
        dontAskCb.checked = !!localStorage.getItem('suppressDeleteConfirm'); // reflect pref
        modal.style.display = 'flex';
      }

      function closeModal() {
        pendingRowId = null;
        modal.style.display = 'none';
      }

      // main entry: called from buttons in the table
      window.deleteRow = async function (rowId) {
        // if user previously chose "don't ask again", skip modal
        if (localStorage.getItem('suppressDeleteConfirm')) {
          return performDelete(rowId);
        }
        openModalFor(rowId);
      };

      okBtn.addEventListener('click', function () {
        if (dontAskCb.checked) {
          localStorage.setItem('suppressDeleteConfirm', '1');
        }
        if (pendingRowId) {
          performDelete(pendingRowId);
        }
        closeModal();
      });

      cancelBtn.addEventListener('click', function () {
        closeModal();
      });

      document.getElementById('reset-delete-confirm').addEventListener('click', function () {
        localStorage.removeItem('suppressDeleteConfirm');
        alert('Delete confirmation reset. You will be asked before deleting rows.');
      });

      async function performDelete(rowId) {
        try {
          const dayInput = document.querySelector('input[name="day"]');
          const clinicInput = document.querySelector('input[name="clinic"]');
          const day = dayInput ? dayInput.value : '';
          const clinic = clinicInput ? clinicInput.value : '';

          const form = new FormData();
          form.append('row_id', rowId);
          form.append('day', day);
          form.append('clinic', clinic);
          const resp = await fetch("{{ url_for('delete_row') }}", {
            method: 'POST',
            body: form,
            credentials: 'same-origin'
          });
          if (!resp.ok) {
            console.error('delete_row failed', resp.status, await resp.text());
            alert('Failed to delete row (see console).');
            return;
          }
          // reload results page to show updated rows
          window.location.href = "{{ url_for('results') }}?day=" + encodeURIComponent(day) + "&clinic=" + encodeURIComponent(clinic);
        } catch (err) {
          console.error(err);
          alert('Error deleting row (see console).');
        }
      }
    }());
  </script>
</body>
</html>
